<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interviews Dashboard - Bloom Buddies</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-flower"></i>
                <span>Interviews Dashboard</span>
            </div>
            <div class="nav-actions">
                <span id="currentUserDisplay" style="margin-right: 15px; color: #667eea; font-weight: 500; display: none;">
                    <i class="fas fa-user-circle"></i> <span id="currentUserName"></span>
                </span>
                <button id="userManagementBtn" class="btn btn-secondary" style="display: none;" onclick="window.location.href='users.html'">
                    <i class="fas fa-users-cog"></i> Users
                </button>
                <button id="refreshBtn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button id="logoutBtn" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="login-form">
                <h2><i class="fas fa-lock"></i> Secure Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <div style="position: relative;">
                            <input type="password" id="password" required style="width: 100%; padding-right: 40px; box-sizing: border-box;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #667eea; font-size: 18px; padding: 0;">
                                <i class="fas fa-eye" id="passwordIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="authCode">Authentication Code:</label>
                        <input type="text" id="authCode" autocomplete="one-time-code" placeholder="2FA code (if required)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <div style="text-align: center; margin-top: 16px;">
                        <a href="/reset-password-request.html" style="color: #667eea; text-decoration: none; font-size: 14px;">
                            <i class="fas fa-key"></i> Forgot Password?
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card" data-filter="all">
                <i class="fas fa-users"></i>
                <div>
                    <h3 id="totalCandidates">0</h3>
                    <p>Total Candidates</p>
                </div>
            </div>
            <div class="stat-card" data-filter="scheduled">
                <i class="fas fa-calendar-check"></i>
                <div>
                    <h3 id="scheduled">0</h3>
                    <p>Scheduled</p>
                </div>
            </div>
            <div class="stat-card" data-filter="pending">
                <i class="fas fa-clock"></i>
                <div>
                    <h3 id="pendingReviews">0</h3>
                    <p>Pending Reviews</p>
                </div>
            </div>
            <div class="stat-card" data-filter="accepted">
                <i class="fas fa-check-circle"></i>
                <div>
                    <h3 id="accepted">0</h3>
                    <p>Accepted</p>
                </div>
            </div>
            <div class="stat-card" data-filter="rejected">
                <i class="fas fa-times-circle"></i>
                <div>
                    <h3 id="rejected">0</h3>
                    <p>Rejected</p>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filters">
            <select id="statusFilter">
                <option value="all">All Status</option>
                <option value="scheduled">Scheduled</option>
                <option value="pending">Pending Review</option>
                <option value="accepted">Accepted</option>
                <option value="rejected">Rejected</option>
            </select>
            <select id="scoreFilter">
                <option value="all">All Scores</option>
                <option value="high">High (7-10)</option>
                <option value="medium">Medium (5-6)</option>
                <option value="low">Low (1-4)</option>
            </select>
            <input type="search" id="searchInput" placeholder="Search candidates...">
        </div>

        <!-- Candidates Grid -->
        <div id="candidatesGrid" class="candidates-grid">
            <!-- Candidate cards will be populated here -->
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading candidates...</p>
        </div>
    </main>

    <!-- Interview Details Modal -->
    <div id="interviewModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="modalCandidateName">Candidate Details</h2>
                <button class="close-btn" onclick="closeModal('interviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="interview-details">
                    <!-- Interview details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="acceptBtn" class="btn btn-success">
                    <i class="fas fa-check"></i> Accept Candidate
                </button>
                <button id="rejectBtn" class="btn btn-danger">
                    <i class="fas fa-times"></i> Reject Candidate
                </button>
                <button class="btn btn-secondary" onclick="closeModal('interviewModal')">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button id="confirmYes" class="btn btn-primary">Yes</button>
                <button id="confirmNo" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script src="config.js?v=1130-1"></script>
    <script src="secure-config.js?v=1130-1"></script>
    <script src="security.js?v=1130-1"></script>
    <script src="auth.js?v=1130-1"></script>
    <script src="airtable.js?v=1130-2"></script>
    <script src="dashboard.js?v=1130-2"></script>
    
    <script>
        // One-time cleanup of old sessions (before JWT implementation)
        (function() {
            const cleanupVersion = 'jwt-migration-v2'; // Bumped version to force re-cleanup
            const cleanupDone = localStorage.getItem('auth-cleanup-version');
            
            if (cleanupDone !== cleanupVersion) {
                console.log('ðŸ§¹ Cleaning up old session data...');
                // Clear ALL localStorage
                localStorage.clear();
                localStorage.setItem('auth-cleanup-version', cleanupVersion);
                console.log('âœ… Old session data cleaned, reloading...');
                // Reload page to start fresh
                window.location.reload();
                return;
            }
        })();

        // Initialize the application
        let auth, airtable, dashboard;
        
        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ DOM loaded, initializing secure app...');
            console.log('ðŸ“ Current URL:', window.location.href);
            console.log('ðŸ” SECURE_CONFIG available:', typeof SECURE_CONFIG !== 'undefined');
            console.log('ðŸ›¡ï¸ SECURITY_MANAGER available:', typeof SECURITY_MANAGER !== 'undefined');
            
            try {
                // Load configuration from server first
                if (typeof loadConfigFromServer === 'function') {
                    await loadConfigFromServer();
                }
                
                // Ensure form elements exist before initializing AuthManager
                setTimeout(() => {
                    if (document.getElementById('email') && document.getElementById('password') && document.getElementById('authCode')) {
                        // Initialize auth first
                        auth = new AuthManager();
                        console.log('Auth manager initialized');
                    } else {
                        console.error('Form elements not found in DOM');
                    }
                }, 100);
                
                // Only initialize airtable if we have authentication or a token
                const hasToken = CONFIG.airtable.personalAccessToken && 
                                CONFIG.airtable.personalAccessToken !== '' &&
                                CONFIG.airtable.personalAccessToken !== 'YOUR_AIRTABLE_PAT_HERE';
                
                if (auth.isAuthenticated() || hasToken) {
                    // Initialize airtable
                    airtable = new AirtableManager();
                    window.airtable = airtable; // Make airtable globally available
                    console.log('Airtable manager initialized');
                    
                    // Test Airtable connection if method exists
                    if (typeof airtable.testConnection === 'function') {
                        airtable.testConnection().then(success => {
                            if (success) {
                                console.log('âœ… Airtable connection test passed');
                            } else {
                                console.error('âŒ Airtable connection test failed');
                            }
                        });
                    }
                } else {
                    console.log('â³ Waiting for authentication before initializing Airtable...');
                }
                
                // Function to update user display
                function updateUserDisplay() {
                    if (auth && auth.currentUser) {
                        const userDisplay = document.getElementById('currentUserDisplay');
                        const userName = document.getElementById('currentUserName');
                        if (userDisplay && userName) {
                            userName.textContent = auth.currentUser.name || auth.currentUser.email;
                            userDisplay.style.display = 'inline';
                        }
                    }
                }

                // Initialize dashboard after a short delay to let auth complete
                setTimeout(() => {
                    if (auth && auth.isAuthenticated()) {
                        updateUserDisplay();
                        dashboard = new Dashboard();
                        window.dashboard = dashboard; // Make dashboard globally available
                        console.log('Dashboard initialized');
                    } else {
                        console.log('Waiting for authentication...');
                        // Set up a listener for when authentication completes
                        const checkAuth = setInterval(() => {
                            if (auth && auth.isAuthenticated() && !dashboard) {
                                updateUserDisplay();
                                dashboard = new Dashboard();
                                window.dashboard = dashboard; // Make dashboard globally available
                                console.log('Dashboard initialized after login');
                                clearInterval(checkAuth);
                            }
                        }, 500);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        });
    </script>
</body>
</html>