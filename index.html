<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interview Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; display: grid; place-items: center; min-height: 100vh; }
    .card { padding: 24px 28px; border: 1px solid #e5e7eb; border-radius: 14px; max-width: 640px; width: 92%; }
    .muted { color: #6b7280; font-size: 0.95rem; margin-top: 6px; }
    .ok { color: #065f46; }
    .err { color: #7f1d1d; }
    .btn { margin-top: 14px; display: inline-block; padding: 10px 14px; border-radius: 10px; border: 1px solid #d1d5db; background: #f9fafb; cursor: default; }
  </style>
</head>
<body>
  <div class="card">
    <div id="status">Verifying your interview link…</div>
    <div id="details" class="muted"></div>
    <div class="btn" id="readyButton" aria-disabled="true">Ready to connect</div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');
    const readyBtn  = document.getElementById('readyButton');

    // 1) Read token from URL ?token=...  (same approach as your prior snippet)
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      statusEl.className = 'err';
      statusEl.textContent = '❌ Invalid link: missing token';
      throw new Error('No token in URL');
    }

    // 2) Validate the token with n8n BEFORE loading Vapi
    //    You can switch this URL to your exact webhook path.
    //    Example from your previous page is kept here:
    //    https://hpettitt.app.n8n.cloud/webhook-test/2a82d555-61c2-4755-82c2-ecca3b62f35b?token=...
    const N8N_VALIDATE_URL =
      `https://hpettitt.app.n8n.cloud/webhook-test/7f4093f8-c5d3-4738-9a2d-606e9633d2e7?token=${encodeURIComponent(token)}`;

    (async () => {
      try {
        const res = await fetch(N8N_VALIDATE_URL, { method: 'GET' });
        const data = await res.json();

        if (!data || data.valid !== true) {
          statusEl.className = 'err';
          statusEl.textContent = '❌ ' + (data && data.error ? data.error : 'Link expired or invalid');
          return;
        }

        // Expecting n8n to return candidate info (you can extend it to also include appointment time)
        const name = data.candidateName || 'candidate';
        const appt = data.appointmentTime; // optional — add in your n8n response when ready

        statusEl.className = 'ok';
        statusEl.textContent = `Hello ${name}! Connecting to your interviewer…`;
        detailsEl.textContent = appt ? `Your appointment: ${appt}` : '';

        // Make the CTA look “active” (we keep it non-clickable since Vapi auto-injects its own phone UI)
        readyBtn.style.background = '#eef2ff';
        readyBtn.style.borderColor = '#c7d2fe';
        readyBtn.style.cursor = 'pointer';
        readyBtn.setAttribute('aria-disabled', 'false');
        readyBtn.title = 'Click to load the call widget. Then a phone button will appear to connect.';

        // 3) Load the Vapi SDK and start the call, passing token in metadata
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js';
        script.async = true;
        script.onload = () => {
          // Optional: gate the run behind a click so your instructions are clear
          readyBtn.addEventListener('click', () => {
            window.vapiSDK.run({
              apiKey: 'f3a732ca-378e-40ca-88e2-7a39d326a8e0',   // UUID only (no pk_)
              assistant: '778ec8a9-8f3e-4a38-9606-46752d4f830b',
              config: { disableDefaultButton: false },          // show the telephone button after click
              metadata: { token }                                // critical: n8n will use this to find the Airtable row
            });
            // Update helper text for UX
            detailsEl.textContent =
              'Click the phone button that just appeared to connect to your interviewer.';
          }, { once: true });
        };
        document.head.appendChild(script);
      } catch (err) {
        console.error('Validation failed:', err);
        statusEl.className = 'err';
        statusEl.textContent = '⚠️ Connection error. Please try again later.';
      }
    })();
  </script>
</body>
</html>
