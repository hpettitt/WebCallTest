<!DOCTYPE html>
<html>
<head>
  <title>Interview Call</title>
  <meta charset="utf-8">
</head>
<body>
  <div id="status">Verifying your interview link...</div>

<script>
  const status = document.getElementById('status');
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      status.textContent = "❌ Invalid link: missing token";
      throw new Error("No token");
    }
  // ✅ Validate token via n8n BEFORE starting call
    fetch(`https://hpettitt.app.n8n.cloud/webhook-test/2a82d555-61c2-4755-82c2-ecca3b62f35b?token=${encodeURIComponent(token)}`)
      .then(res => res.json())
      .then(data => {
        if (!data.valid) {
          status.textContent = "❌ " + (data.error || "Link expired or invalid");
          return;
        }

        status.textContent = `Hello ${data.candidateName}! Connecting to interviewer...`;
       // ✅ Load Vapi SDK and start call
   // ✅ Load Vapi SDK and start call
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
        script.onload = () => {
          window.vapiSDK.run({
            apiKey: "f3a732ca-378e-40ca-88e2-7a39d326a8e0", // UUID only (no pk_)
            assistant: "778ec8a9-8f3e-4a38-9606-46752d4f830b",
            config: { disableDefaultButton: true },
            meta: { token } // ← critical for webhook
          });
        };
        document.head.appendChild(script);
      })
      .catch(err => {
        console.error("Validation failed:", err);
        status.textContent = "⚠️ Connection error. Please try again later.";
      });
  </script>
</body>
</html>
